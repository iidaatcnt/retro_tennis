<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ãƒˆãƒ­ãƒ†ãƒ‹ã‚¹</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        #gameTitle {
            font-size: 24px;
            margin-bottom: 10px;
            text-align: center;
            color: #ffeb3b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            animation: rainbow 3s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        #scoreBoard {
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #4ecdc4;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .score-section {
            margin: 5px 0;
            color: #e8f5e8;
        }
        
        #games1, #games2 {
            color: #ff6b6b;
            font-weight: bold;
            font-size: 20px;
        }
        
        #points1, #points2 {
            color: #4ecdc4;
            font-weight: bold;
            font-size: 18px;
        }
        
        #status {
            color: #ffeb3b !important;
            font-weight: bold;
            margin-top: 5px !important;
        }
        
        #gameCanvas {
            border: 3px solid #ff6b6b;
            background: linear-gradient(45deg, #0f3460, #16537e);
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        #controls {
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #96ceb4;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #45b7d1;
        }
        
        .blink {
            animation: colorBlink 1.5s infinite;
        }
        
        @keyframes colorBlink {
            0%, 100% { color: #ffeb3b; }
            25% { color: #ff6b6b; }
            50% { color: #4ecdc4; }
            75% { color: #45b7d1; }
        }
    </style>
</head>
<body>
    <div id="gameTitle">â˜… RETRO TENNIS â˜…</div>
    <div id="scoreBoard">
        <div class="score-section">ã‚²ãƒ¼ãƒ : ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ <span id="games1">0</span> - <span id="games2">0</span> ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼</div>
        <div class="score-section">ãƒã‚¤ãƒ³ãƒˆ: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ <span id="points1">0</span> - <span id="points2">0</span> ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼</div>
        <div class="score-section" id="status"></div>
    </div>
    
    <div id="demoText" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
         background: rgba(255, 255, 255, 0.95); color: #333; padding: 20px; border-radius: 10px; 
         font-size: 18px; font-weight: bold; text-align: center; z-index: 1000;
         box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid #4ecdc4;">
        ğŸ® ãƒ‡ãƒ¢ãƒ—ãƒ¬ã‚¤ä¸­ ğŸ®<br>
        <span style="font-size: 14px; color: #666;">ä½•ã‹ã‚­ãƒ¼ã‚’æŠ¼ã™ã¨ãƒ—ãƒ¬ã‚¤ã§ãã¾ã™</span>
    </div>
    
    <canvas id="gameCanvas" width="600" height="400"></canvas>
    <div id="controls">
        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: W/S ã‚­ãƒ¼ (ã‚µãƒ¼ãƒ–æ™‚ä½ç½®èª¿æ•´ã‚‚å¯èƒ½)<br>
        <span class="blink">SPACE ã‚­ãƒ¼ã§ã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚µãƒ¼ãƒ–</span>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = 'waiting'; // 'waiting', 'serving', 'playing', 'paused', 'gameWon', 'matchWon'
        
        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        let demoState = {
            isDemo: false,
            lastUserInput: Date.now(),
            demoStartTime: 0,
            demoActionTimer: 0,
            waitingTimer: 0,  // å„çŠ¶æ…‹ã§ã®å¾…æ©Ÿã‚¿ã‚¤ãƒãƒ¼
            lastState: ''      // å‰å›ã®çŠ¶æ…‹ã‚’è¨˜éŒ²
        };
        
        // ãƒ†ãƒ‹ã‚¹ã‚¹ã‚³ã‚¢
        let tennisScore = {
            games: [0, 0], // ã‚»ãƒƒãƒˆã¯å‰Šé™¤ã€ã‚²ãƒ¼ãƒ æ•°ã®ã¿
            points: [0, 0],
            isDeuce: false,
            advantage: -1, // -1: ãªã—, 0: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1, 1: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2
            currentServer: 0, // 0: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1, 1: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2
            isMatchWon: false,
            winner: -1
        };
        
        // ãƒ‘ãƒ‰ãƒ«è¨­å®š
        const paddleWidth = 10;
        const paddleHeight = 60;
        const paddleSpeed = 5;
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼ˆå·¦ãƒ»äººé–“ï¼‰
        let player1 = {
            x: 20,
            y: canvas.height / 2 - paddleHeight / 2,
            dy: 0,
            prevY: canvas.height / 2 - paddleHeight / 2,
            velocity: 0
        };
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ï¼ˆå³ãƒ»ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ï¼‰
        let player2 = {
            x: canvas.width - 30,
            y: canvas.height / 2 - paddleHeight / 2,
            dy: 0,
            targetY: canvas.height / 2 - paddleHeight / 2,
            difficulty: 0.8, // 0.0-1.0, é«˜ã„ã»ã©å¼·ã„
            prevY: canvas.height / 2 - paddleHeight / 2,
            velocity: 0,
            reactionDelay: 0, // åå¿œé…å»¶ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
            predictionError: 0 // äºˆæ¸¬èª¤å·®
        };
        
        // ãƒœãƒ¼ãƒ«è¨­å®š
        let ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            dx: 3,
            dy: 2,
            size: 8,
            hitCount: 0, // ãƒ©ãƒªãƒ¼å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            scored: false // ãƒã‚¤ãƒ³ãƒˆæ¸ˆã¿ãƒ•ãƒ©ã‚°
        };
        
        // ã‚­ãƒ¼å…¥åŠ›ç®¡ç†
        const keys = {};
        
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒã‚ã£ãŸã‚‰ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã‚’åœæ­¢
            if (demoState.isDemo && (e.key === ' ' || e.key.toLowerCase() === 'w' || e.key.toLowerCase() === 's')) {
                stopDemo();
            }
            
            demoState.lastUserInput = Date.now();
            
            if (e.key === ' ') {
                if (gameState === 'waiting') {
                    startServing();
                } else if (gameState === 'serving') {
                    serveGame();
                } else if (gameState === 'gameWon') {
                    nextGame();
                } else if (gameState === 'matchWon') {
                    resetMatch();
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
            demoState.lastUserInput = Date.now();
        });
        
        function getPointDisplay(points, isDeuce, advantage, playerIndex) {
            if (isDeuce) {
                if (advantage === -1) return "40";
                if (advantage === playerIndex) return "Ad";
                return "40";
            }
            
            // ãƒ†ãƒ‹ã‚¹ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º: 0, 15, 30, 40
            const pointNames = ["0", "15", "30", "40"];
            return pointNames[Math.min(points, 3)];
        }
        
        function updateScoreDisplay() {
            document.getElementById('games1').textContent = tennisScore.games[0];
            document.getElementById('games2').textContent = tennisScore.games[1];
            
            // ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã®å‡¦ç†
            document.getElementById('points1').textContent = getPointDisplay(
                tennisScore.points[0], tennisScore.isDeuce, tennisScore.advantage, 0
            );
            document.getElementById('points2').textContent = getPointDisplay(
                tennisScore.points[1], tennisScore.isDeuce, tennisScore.advantage, 1
            );
            
            let status = "";
            
            // ãƒ‡ãƒ¥ãƒ¼ã‚¹ãƒ»ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸ã®çŠ¶æ…‹è¡¨ç¤º
            if (tennisScore.isDeuce) {
                if (tennisScore.advantage === -1) {
                    status = "ãƒ‡ãƒ¥ãƒ¼ã‚¹";
                } else if (tennisScore.advantage === 0) {
                    status = "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸";
                } else if (tennisScore.advantage === 1) {
                    status = "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸";
                }
            }
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã«ã‚ˆã‚‹ä¸Šæ›¸ã
            if (gameState === 'gameWon') {
                status = `${tennisScore.winner === 0 ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼'} ã‚²ãƒ¼ãƒ å‹åˆ©! (SPACE ã§æ¬¡ã®ã‚²ãƒ¼ãƒ )`;
            } else if (gameState === 'matchWon') {
                status = `${tennisScore.winner === 0 ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼'} ãƒãƒƒãƒå‹åˆ©! (SPACE ã§ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ)`;
            } else if (gameState === 'serving') {
                if (tennisScore.currentServer === 0) {
                    status = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚µãƒ¼ãƒ– - W/Sã§ä½ç½®èª¿æ•´ã€SPACEã§ã‚µãƒ¼ãƒ–`;
                } else {
                    status = `ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®ã‚µãƒ¼ãƒ–`;
                }
            } else if (gameState === 'playing') {
                // ãƒ—ãƒ¬ã‚¤ä¸­ã¯ãƒ‡ãƒ¥ãƒ¼ã‚¹çŠ¶æ…‹ã‚’å„ªå…ˆã—ã¦è¡¨ç¤º
                if (!tennisScore.isDeuce) {
                    status = `ã‚µãƒ¼ãƒãƒ¼: ${tennisScore.currentServer === 0 ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼'}`;
                }
            }
            
            document.getElementById('status').textContent = status;
        }
        
        function addPoint(playerIndex) {
            if (tennisScore.isMatchWon) return;
            
            if (tennisScore.isDeuce) {
                if (tennisScore.advantage === -1) {
                    // ãƒ‡ãƒ¥ãƒ¼ã‚¹ã‹ã‚‰ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸ã¸
                    tennisScore.advantage = playerIndex;
                } else if (tennisScore.advantage === playerIndex) {
                    // ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸ã‹ã‚‰ã‚²ãƒ¼ãƒ å‹åˆ©
                    winGame(playerIndex);
                    return;
                } else {
                    // ç›¸æ‰‹ã®ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸ã‹ã‚‰å†ã³ãƒ‡ãƒ¥ãƒ¼ã‚¹ã¸
                    tennisScore.advantage = -1;
                }
            } else {
                // é€šå¸¸ã®ãƒã‚¤ãƒ³ãƒˆé€²è¡Œ 0 â†’ 1 â†’ 2 â†’ 3 â†’ ã‚²ãƒ¼ãƒ å‹åˆ©
                tennisScore.points[playerIndex]++;
                
                // ã‚²ãƒ¼ãƒ å‹åˆ©åˆ¤å®š
                if (tennisScore.points[playerIndex] >= 4) {
                    if (tennisScore.points[playerIndex] - tennisScore.points[1 - playerIndex] >= 2) {
                        // 2ãƒã‚¤ãƒ³ãƒˆå·®ã§ã‚²ãƒ¼ãƒ å‹åˆ©
                        winGame(playerIndex);
                        return;
                    } else if (tennisScore.points[0] >= 3 && tennisScore.points[1] >= 3) {
                        // ä¸¡æ–¹ãŒ3ãƒã‚¤ãƒ³ãƒˆä»¥ä¸Šã§ãƒ‡ãƒ¥ãƒ¼ã‚¹
                        tennisScore.isDeuce = true;
                    }
                }
            }
            
            updateScoreDisplay();
        }
        
        function winGame(playerIndex) {
            tennisScore.games[playerIndex]++;
            tennisScore.winner = playerIndex;
            
            // ãƒãƒƒãƒå‹åˆ©åˆ¤å®š - 3ã‚²ãƒ¼ãƒ å…ˆå–ã§å‹åˆ©
            if (tennisScore.games[playerIndex] >= 3) {
                tennisScore.isMatchWon = true;
                gameState = 'matchWon';
            } else {
                gameState = 'gameWon';
            }
            
            updateScoreDisplay();
        }
        
        function startServing() {
            gameState = 'serving';
            prepareServe();
            updateScoreDisplay();
        }
        
        function prepareServe() {
            // ã‚µãƒ¼ãƒ–æº–å‚™ï¼šãƒœãƒ¼ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã®ä½ç½®ã«é…ç½®
            if (tennisScore.currentServer === 0) {
                ball.x = player1.x + paddleWidth + 15;
                ball.y = player1.y + paddleHeight / 2;
            } else {
                ball.x = player2.x - 15;
                ball.y = player2.y + paddleHeight / 2;
                // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¯è‡ªå‹•ã§ã‚µãƒ¼ãƒ–
                setTimeout(() => serveGame(), 1000);
            }
        }
        
        function serveGame() {
            gameState = 'playing';
            ball.hitCount = 0; // ãƒ©ãƒªãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
            ball.scored = false; // ãƒã‚¤ãƒ³ãƒˆæ¸ˆã¿ãƒ•ãƒ©ã‚°ãƒªã‚»ãƒƒãƒˆ
            
            // ã‚µãƒ¼ãƒ–ã®æ–¹å‘ã¨é€Ÿåº¦ã‚’è¨­å®š
            if (tennisScore.currentServer === 0) {
                ball.dx = 4;
                ball.dy = (Math.random() - 0.5) * 3;
            } else {
                ball.dx = -4;
                ball.dy = (Math.random() - 0.5) * 3;
            }
            
            updateScoreDisplay();
        }
        
        function nextGame() {
            // ã‚µãƒ¼ãƒãƒ¼äº¤ä»£
            tennisScore.currentServer = 1 - tennisScore.currentServer;
            
            // ãƒã‚¤ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
            tennisScore.points = [0, 0];
            tennisScore.isDeuce = false;
            tennisScore.advantage = -1;
            
            startServing();
        }
        
        function resetMatch() {
            tennisScore = {
                games: [0, 0],
                points: [0, 0],
                isDeuce: false,
                advantage: -1,
                currentServer: 0,
                isMatchWon: false,
                winner: -1
            };
            gameState = 'waiting';
            updateScoreDisplay();
        }
        
        function resetBall() {
            // æ¬¡ã®ãƒã‚¤ãƒ³ãƒˆã®ãŸã‚ã®ã‚µãƒ¼ãƒ–æº–å‚™
            startServing();
        }
        
        function updateGame() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼ˆäººé–“ï¼‰ã®ç§»å‹•ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰è¨ˆç®—
            player1.prevY = player1.y;
            if (keys['w'] && player1.y > 0) {
                player1.y -= paddleSpeed;
            }
            if (keys['s'] && player1.y < canvas.height - paddleHeight) {
                player1.y += paddleSpeed;
            }
            player1.velocity = player1.y - player1.prevY;
            
            // ã‚µãƒ¼ãƒ–æº–å‚™ä¸­ã®å‡¦ç†
            if (gameState === 'serving') {
                if (tennisScore.currentServer === 0) {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚µãƒ¼ãƒ–æº–å‚™ä¸­ï¼šãƒœãƒ¼ãƒ«ã‚‚ä¸€ç·’ã«ç§»å‹•
                    ball.y = player1.y + paddleHeight / 2;
                } else {
                    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®ã‚µãƒ¼ãƒ–æº–å‚™ä¸­
                    updateComputerPlayer();
                    ball.y = player2.y + paddleHeight / 2;
                }
                return;
            }
            
            if (gameState !== 'playing') return;
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ï¼ˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ï¼‰ã®AI
            updateComputerPlayer();
            
            // ãƒœãƒ¼ãƒ«ã®ç§»å‹•
            ball.x += ball.dx;
            ball.y += ball.dy;
            
            // ä¸Šä¸‹ã®å£ã¨ã®è¡çª
            if (ball.y <= ball.size || ball.y >= canvas.height - ball.size) {
                ball.dy = -ball.dy;
            }
            
            // ãƒ‘ãƒ‰ãƒ«ã¨ã®è¡çªåˆ¤å®š
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ãƒ‘ãƒ‰ãƒ«
            if (ball.x - ball.size <= player1.x + paddleWidth &&
                ball.y >= player1.y &&
                ball.y <= player1.y + paddleHeight &&
                ball.dx < 0) {
                ball.dx = -ball.dx;
                ball.dx *= 1.02;
                // ãƒ‘ãƒ‰ãƒ«ã®å‹•ãã‚’ãƒœãƒ¼ãƒ«ã«åæ˜ 
                ball.dy += player1.velocity * 0.3;
                ball.hitCount++; // ãƒ©ãƒªãƒ¼å›æ•°å¢—åŠ 
            }
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®ãƒ‘ãƒ‰ãƒ«
            if (ball.x + ball.size >= player2.x &&
                ball.y >= player2.y &&
                ball.y <= player2.y + paddleHeight &&
                ball.dx > 0) {
                ball.dx = -ball.dx;
                ball.dx *= 1.02;
                // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ‰ãƒ«ã®å‹•ãã‚’ãƒœãƒ¼ãƒ«ã«åæ˜ 
                ball.dy += player2.velocity * 0.3;
                ball.hitCount++; // ãƒ©ãƒªãƒ¼å›æ•°å¢—åŠ 
            }
            
            // ãƒã‚¤ãƒ³ãƒˆåˆ¤å®š
            if (!ball.scored) { // ã¾ã ãƒã‚¤ãƒ³ãƒˆãŒä»˜ã„ã¦ã„ãªã„å ´åˆã®ã¿
                if (ball.x < 0) {
                    ball.scored = true; // ãƒã‚¤ãƒ³ãƒˆæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                    addPoint(1); // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆ
                    ball.hitCount = 0; // ãƒ©ãƒªãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
                    if (gameState === 'playing') {
                        setTimeout(() => resetBall(), 1000);
                    }
                } else if (ball.x > canvas.width) {
                    ball.scored = true; // ãƒã‚¤ãƒ³ãƒˆæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                    addPoint(0); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆ
                    ball.hitCount = 0; // ãƒ©ãƒªãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
                    if (gameState === 'playing') {
                        setTimeout(() => resetBall(), 1000);
                    }
                }
            }
        }
        
        function updateComputerPlayer() {
            // å‰å›ã®ä½ç½®ã‚’è¨˜éŒ²
            player2.prevY = player2.y;
            
            // åå¿œé…å»¶ã‚’å‡¦ç†
            if (player2.reactionDelay > 0) {
                player2.reactionDelay--;
                return; // é…å»¶ä¸­ã¯ç§»å‹•ã—ãªã„
            }
            
            // ãƒ©ãƒªãƒ¼å›æ•°ã«åŸºã¥ãé›£æ˜“åº¦ä½ä¸‹ã®è¨ˆç®—
            let rallyDifficulty = Math.max(0.3, player2.difficulty - (ball.hitCount * 0.08));
            let fatigueMultiplier = Math.max(0.4, 1 - (ball.hitCount * 0.06));
            
            // ãƒœãƒ¼ãƒ«ãŒã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼å´ã«å‘ã‹ã£ã¦ã„ã‚‹å ´åˆ
            if (ball.dx > 0) {
                // ãƒ©ãƒªãƒ¼ãŒç¶šãã¨åå¿œãŒé…ããªã‚‹
                if (ball.hitCount > 3 && Math.random() < 0.15 + (ball.hitCount * 0.05)) {
                    player2.reactionDelay = Math.floor(2 + ball.hitCount * 0.5);
                    return;
                }
                
                // ãƒœãƒ¼ãƒ«ã®äºˆæ¸¬ä½ç½®ã‚’è¨ˆç®—
                let timeToReach = (player2.x - ball.x) / ball.dx;
                let predictedY = ball.y + (ball.dy * timeToReach);
                
                // å£ã§ã®è·³ã­è¿”ã‚Šã‚’è€ƒæ…®
                let bounceCount = 0;
                while (predictedY < 0 || predictedY > canvas.height) {
                    bounceCount++;
                    if (predictedY < 0) {
                        predictedY = -predictedY;
                    }
                    if (predictedY > canvas.height) {
                        predictedY = 2 * canvas.height - predictedY;
                    }
                    
                    // è¤‡æ•°å›è·³ã­è¿”ã‚ŠãŒã‚ã‚‹ã¨äºˆæ¸¬ç²¾åº¦ãŒè½ã¡ã‚‹
                    if (bounceCount > 1 && ball.hitCount > 2) {
                        let bounceError = (Math.random() - 0.5) * 40 * bounceCount;
                        predictedY += bounceError;
                    }
                }
                
                player2.targetY = predictedY - paddleHeight / 2;
                
                // ãƒ©ãƒªãƒ¼ãŒç¶šãã¨äºˆæ¸¬èª¤å·®ãŒå¤§ãããªã‚‹
                if (ball.hitCount > 2) {
                    let predictionErrorRange = 20 + (ball.hitCount * 8);
                    player2.predictionError = (Math.random() - 0.5) * predictionErrorRange * (1 - rallyDifficulty);
                    player2.targetY += player2.predictionError;
                }
            } else {
                // ãƒœãƒ¼ãƒ«ãŒé›¢ã‚Œã¦ã„ãå ´åˆã¯ä¸­å¤®ã«æˆ»ã‚‹ï¼ˆç–²åŠ´ã§é…ããªã‚‹ï¼‰
                player2.targetY = canvas.height / 2 - paddleHeight / 2;
            }
            
            // é›£æ˜“åº¦ã¨ãƒ©ãƒªãƒ¼ç–²åŠ´ã«åŸºã¥ã„ãŸç§»å‹•é€Ÿåº¦
            let baseSpeed = paddleSpeed * rallyDifficulty * fatigueMultiplier;
            
            // ãƒ©ãƒªãƒ¼ãŒç¶šãã¨ã•ã‚‰ã«é…ããªã‚‹
            if (ball.hitCount > 5) {
                baseSpeed *= Math.max(0.3, 1 - ((ball.hitCount - 5) * 0.1));
            }
            
            // åŸºæœ¬çš„ãªãƒ©ãƒ³ãƒ€ãƒ ã‚¨ãƒ©ãƒ¼
            let basicError = (Math.random() - 0.5) * 25 * (1 - rallyDifficulty);
            let adjustedTargetY = player2.targetY + basicError;
            
            // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
            adjustedTargetY = Math.max(0, Math.min(canvas.height - paddleHeight, adjustedTargetY));
            
            // ã‚¹ãƒ ãƒ¼ã‚ºãªç§»å‹•
            let diff = adjustedTargetY - player2.y;
            if (Math.abs(diff) > baseSpeed) {
                player2.y += diff > 0 ? baseSpeed : -baseSpeed;
            } else {
                player2.y = adjustedTargetY;
            }
            
            // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
            player2.y = Math.max(0, Math.min(canvas.height - paddleHeight, player2.y));
            
            // é€Ÿåº¦ã‚’è¨ˆç®—
            player2.velocity = player2.y - player2.prevY;
        }
        
        function drawGame() {
            // ç”»é¢ã‚¯ãƒªã‚¢ - ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#0f3460');
            gradient.addColorStop(1, '#16537e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ä¸­å¤®ç·šã‚’æç”» - æ˜ã‚‹ã„é’
            ctx.strokeStyle = '#4ecdc4';
            ctx.lineWidth = 3;
            ctx.setLineDash([15, 10]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // ãƒ‘ãƒ‰ãƒ«ã‚’æç”» - ã‚«ãƒ©ãƒ•ãƒ«
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒ‰ãƒ«ï¼ˆå·¦ï¼‰- èµ¤ç³»
            if (demoState.isDemo) {
                ctx.shadowColor = '#00ffff';
                ctx.shadowBlur = 15;
            }
            const playerGradient = ctx.createLinearGradient(player1.x, player1.y, player1.x + paddleWidth, player1.y + paddleHeight);
            if (demoState.isDemo) {
                playerGradient.addColorStop(0, '#00ffff');
                playerGradient.addColorStop(1, '#0099cc');
            } else {
                playerGradient.addColorStop(0, '#ff6b6b');
                playerGradient.addColorStop(1, '#ee5a52');
            }
            ctx.fillStyle = playerGradient;
            ctx.fillRect(player1.x, player1.y, paddleWidth, paddleHeight);
            if (demoState.isDemo) {
                ctx.shadowBlur = 0;
            }
            
            // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ‰ãƒ«ï¼ˆå³ï¼‰- ç·‘ç³»
            const computerGradient = ctx.createLinearGradient(player2.x, player2.y, player2.x + paddleWidth, player2.y + paddleHeight);
            computerGradient.addColorStop(0, '#96ceb4');
            computerGradient.addColorStop(1, '#74b9a0');
            ctx.fillStyle = computerGradient;
            ctx.fillRect(player2.x, player2.y, paddleWidth, paddleHeight);
            
            // ãƒœãƒ¼ãƒ«ã‚’æç”» - æ˜ã‚‹ã„é»„è‰²ã§å…‰ã‚‹åŠ¹æœ
            if (gameState === 'playing' || gameState === 'serving') {
                // ãƒœãƒ¼ãƒ«ã®å½±åŠ¹æœ
                ctx.beginPath();
                ctx.arc(ball.x + 2, ball.y + 2, ball.size, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fill();
                
                // ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ«
                const ballGradient = ctx.createRadialGradient(ball.x - 2, ball.y - 2, 0, ball.x, ball.y, ball.size);
                ballGradient.addColorStop(0, '#ffeb3b');
                ballGradient.addColorStop(1, '#ffc107');
                ctx.fillStyle = ballGradient;
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.size, 0, Math.PI * 2);
                ctx.fill();
                
                // ãƒœãƒ¼ãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(ball.x - 3, ball.y - 3, 2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (gameState === 'waiting') {
                ctx.font = '20px Courier New';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#ffeb3b';
                ctx.strokeStyle = '#ff6b6b';
                ctx.lineWidth = 2;
                ctx.strokeText('SPACE ã‚­ãƒ¼ã§ã‚²ãƒ¼ãƒ é–‹å§‹', canvas.width / 2, canvas.height / 2 + 50);
                ctx.fillText('SPACE ã‚­ãƒ¼ã§ã‚²ãƒ¼ãƒ é–‹å§‹', canvas.width / 2, canvas.height / 2 + 50);
            }
            
            // ã‚µãƒ¼ãƒ–æº–å‚™ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (gameState === 'serving' && tennisScore.currentServer === 0) {
                ctx.font = '16px Courier New';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#4ecdc4';
                ctx.strokeStyle = '#45b7d1';
                ctx.lineWidth = 1;
                ctx.strokeText('W/S ã§ä½ç½®èª¿æ•´, SPACE ã§ã‚µãƒ¼ãƒ–', canvas.width / 2, 30);
                ctx.fillText('W/S ã§ä½ç½®èª¿æ•´, SPACE ã§ã‚µãƒ¼ãƒ–', canvas.width / 2, 30);
            }
        }
        
        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰é–¢é€£é–¢æ•°
        function checkDemoMode() {
            if (demoState.isDemo || gameState !== 'waiting') return;
            
            // 5ç§’é–“æ“ä½œãŒãªã‘ã‚Œã°ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
            if (Date.now() - demoState.lastUserInput > 5000) {
                startDemo();
            }
        }
        
        function startDemo() {
            demoState.isDemo = true;
            demoState.demoStartTime = Date.now();
            demoState.demoActionTimer = 0;
            
            // ãƒ‡ãƒ¢è¡¨ç¤ºã‚’è¡¨ç¤º
            document.getElementById('demoText').style.display = 'block';
            
            // ãƒ‡ãƒ¢ã‚²ãƒ¼ãƒ ã‚’è‡ªå‹•é–‹å§‹
            setTimeout(() => {
                if (demoState.isDemo) {
                    startServing();
                    setTimeout(() => {
                        if (demoState.isDemo && gameState === 'serving') {
                            serveGame();
                        }
                    }, 1500);
                }
            }, 500);
        }
        
        function stopDemo() {
            demoState.isDemo = false;
            demoState.lastUserInput = Date.now();
            
            // ãƒ‡ãƒ¢è¡¨ç¤ºã‚’éè¡¨ç¤º
            document.getElementById('demoText').style.display = 'none';
        }
        
        function updateDemoAI() {
            demoState.demoActionTimer++;
            
            // çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã‚‰ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (gameState !== demoState.lastState) {
                demoState.waitingTimer = 0;
                demoState.lastState = gameState;
            }
            demoState.waitingTimer++;
            
            if (gameState === 'playing') {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼ˆå·¦ãƒ‘ãƒ‰ãƒ«ï¼‰ã®AIåˆ¶å¾¡
                const ballCenterY = ball.y;
                const paddleCenterY = player1.y + paddleHeight / 2;
                const targetY = ballCenterY - paddleHeight / 2;
                
                // ã‚¹ãƒ ãƒ¼ã‚ºãªç§»å‹•
                const diff = targetY - player1.y;
                if (Math.abs(diff) > 2) {
                    if (diff > 0) {
                        keys['s'] = true;
                        keys['w'] = false;
                    } else {
                        keys['w'] = true;
                        keys['s'] = false;
                    }
                } else {
                    keys['w'] = false;
                    keys['s'] = false;
                }
            } else if (gameState === 'serving' && tennisScore.currentServer === 0) {
                // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ¼ãƒ–ã‚’è‡ªå‹•åŒ–
                if (demoState.waitingTimer > 60) { // ç´„1ç§’å¾Œã«ã‚µãƒ¼ãƒ–
                    serveGame();
                    demoState.waitingTimer = 0;
                }
            } else if (gameState === 'waiting') {
                // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯è‡ªå‹•ã§ã‚²ãƒ¼ãƒ é–‹å§‹
                if (demoState.waitingTimer > 120) { // ç´„2ç§’å¾Œã«ã‚²ãƒ¼ãƒ é–‹å§‹
                    startServing();
                    demoState.waitingTimer = 0;
                }
            } else if (gameState === 'matchWon') {
                // ãƒãƒƒãƒå‹åˆ©å¾Œã€3ç§’å¾…ã£ã¦å¾…æ©Ÿç”»é¢ã¸æˆ»ã™
                if (demoState.waitingTimer > 180) { // ç´„3ç§’å¾Œ
                    // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¦å¾…æ©Ÿç”»é¢ã¸
                    stopDemo();
                    resetMatch();
                    // å¾…æ©Ÿç”»é¢ã«ãªã£ãŸã®ã§ã€lastUserInputã‚’æ›´æ–°ã—ã¦5ç§’å¾Œã«ã¾ãŸãƒ‡ãƒ¢ãŒå§‹ã¾ã‚‹ã‚ˆã†ã«ã™ã‚‹
                    demoState.lastUserInput = Date.now();
                    demoState.waitingTimer = 0;
                }
            } else {
                keys['w'] = false;
                keys['s'] = false;
            }
        }
        
        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function gameLoop() {
            // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
            if (!demoState.isDemo && gameState === 'waiting') {
                checkDemoMode();
            }
            
            // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ä¸­ã®AIåˆ¶å¾¡
            if (demoState.isDemo) {
                updateDemoAI();
            }
            
            updateGame();
            drawGame();
            requestAnimationFrame(gameLoop);
        }
        
        // åˆæœŸåŒ–
        updateScoreDisplay();
        gameLoop();
    </script>
</body>
</html>