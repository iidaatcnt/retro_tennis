<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É¨„Éà„É≠„ÉÜ„Éã„Çπ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        #gameTitle {
            font-size: 24px;
            margin-bottom: 10px;
            text-align: center;
            color: #ffeb3b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            animation: rainbow 3s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        #scoreBoard {
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #4ecdc4;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .score-section {
            margin: 5px 0;
            color: #e8f5e8;
        }
        
        #games1, #games2 {
            color: #ff6b6b;
            font-weight: bold;
            font-size: 20px;
        }
        
        #points1, #points2 {
            color: #4ecdc4;
            font-weight: bold;
            font-size: 18px;
        }
        
        #status {
            color: #ffeb3b !important;
            font-weight: bold;
            margin-top: 5px !important;
        }
        
        #gameCanvas {
            border: 3px solid #ff6b6b;
            background: linear-gradient(45deg, #0f3460, #16537e);
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        #controls {
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #96ceb4;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #45b7d1;
        }
        
        .blink {
            animation: colorBlink 1.5s infinite;
        }
        
        @keyframes colorBlink {
            0%, 100% { color: #ffeb3b; }
            25% { color: #ff6b6b; }
            50% { color: #4ecdc4; }
            75% { color: #45b7d1; }
        }
    </style>
</head>
<body>
    <div id="gameTitle">‚òÖ RETRO TENNIS ‚òÖ</div>
    <div id="scoreBoard">
        <div class="score-section">„Ç≤„Éº„É†: „Éó„É¨„Ç§„É§„Éº <span id="games1">0</span> - <span id="games2">0</span> „Ç≥„É≥„Éî„É•„Éº„Çø„Éº</div>
        <div class="score-section">„Éù„Ç§„É≥„Éà: „Éó„É¨„Ç§„É§„Éº <span id="points1">0</span> - <span id="points2">0</span> „Ç≥„É≥„Éî„É•„Éº„Çø„Éº</div>
        <div class="score-section" id="status"></div>
    </div>
    
    <div id="demoText" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
         background: rgba(255, 255, 255, 0.95); color: #333; padding: 20px; border-radius: 10px; 
         font-size: 18px; font-weight: bold; text-align: center; z-index: 1000;
         box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid #4ecdc4;">
        üéÆ „Éá„É¢„Éó„É¨„Ç§‰∏≠ üéÆ<br>
        <span style="font-size: 14px; color: #666;">‰Ωï„Åã„Ç≠„Éº„ÇíÊäº„Åô„Å®„Éó„É¨„Ç§„Åß„Åç„Åæ„Åô</span>
    </div>
    
    <canvas id="gameCanvas" width="600" height="400"></canvas>
    <div id="controls">
        „Éó„É¨„Ç§„É§„Éº: W/S „Ç≠„Éº („Çµ„Éº„ÉñÊôÇ‰ΩçÁΩÆË™øÊï¥„ÇÇÂèØËÉΩ)<br>
        <span class="blink">SPACE „Ç≠„Éº„Åß„Çπ„Çø„Éº„Éà/„Çµ„Éº„Éñ</span>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = 'waiting'; // 'waiting', 'serving', 'playing', 'paused', 'gameWon', 'matchWon'
        
        // „Éá„É¢„É¢„Éº„ÉâÁÆ°ÁêÜ
        let demoState = {
            isDemo: false,
            lastUserInput: Date.now(),
            demoStartTime: 0,
            demoActionTimer: 0,
            waitingTimer: 0,  // ÂêÑÁä∂ÊÖã„Åß„ÅÆÂæÖÊ©ü„Çø„Ç§„Éû„Éº
            lastState: ''      // ÂâçÂõû„ÅÆÁä∂ÊÖã„ÇíË®òÈå≤
        };
        
        // „ÉÜ„Éã„Çπ„Çπ„Ç≥„Ç¢
        let tennisScore = {
            games: [0, 0], // „Çª„ÉÉ„Éà„ÅØÂâäÈô§„ÄÅ„Ç≤„Éº„É†Êï∞„ÅÆ„Åø
            points: [0, 0],
            isDeuce: false,
            advantage: -1, // -1: „Å™„Åó, 0: „Éó„É¨„Ç§„É§„Éº1, 1: „Éó„É¨„Ç§„É§„Éº2
            currentServer: 0, // 0: „Éó„É¨„Ç§„É§„Éº1, 1: „Éó„É¨„Ç§„É§„Éº2
            isMatchWon: false,
            winner: -1
        };
        
        // „Éë„Éâ„É´Ë®≠ÂÆö
        const paddleWidth = 10;
        const paddleHeight = 60;
        const paddleSpeed = 5;
        
        // „Éó„É¨„Ç§„É§„Éº1ÔºàÂ∑¶„Éª‰∫∫ÈñìÔºâ
        let player1 = {
            x: 20,
            y: canvas.height / 2 - paddleHeight / 2,
            dy: 0,
            prevY: canvas.height / 2 - paddleHeight / 2,
            velocity: 0
        };
        
        // „Éó„É¨„Ç§„É§„Éº2ÔºàÂè≥„Éª„Ç≥„É≥„Éî„É•„Éº„Çø„ÉºÔºâ
        let player2 = {
            x: canvas.width - 30,
            y: canvas.height / 2 - paddleHeight / 2,
            dy: 0,
            targetY: canvas.height / 2 - paddleHeight / 2,
            difficulty: 0.8, // 0.0-1.0, È´ò„ÅÑ„Åª„Å©Âº∑„ÅÑ
            prevY: canvas.height / 2 - paddleHeight / 2,
            velocity: 0,
            reactionDelay: 0, // ÂèçÂøúÈÅÖÂª∂„Éï„É¨„Éº„É†Êï∞
            predictionError: 0 // ‰∫àÊ∏¨Ë™§Â∑Æ
        };
        
        // „Éú„Éº„É´Ë®≠ÂÆö
        let ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            dx: 3,
            dy: 2,
            size: 8,
            hitCount: 0, // „É©„É™„ÉºÂõûÊï∞„Çí„Ç´„Ç¶„É≥„Éà
            scored: false // „Éù„Ç§„É≥„ÉàÊ∏à„Åø„Éï„É©„Ç∞
        };
        
        // „Ç≠„ÉºÂÖ•ÂäõÁÆ°ÁêÜ
        const keys = {};
        
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            
            // „É¶„Éº„Ç∂„ÉºÂÖ•Âäõ„Åå„ÅÇ„Å£„Åü„Çâ„Éá„É¢„É¢„Éº„Éâ„ÇíÂÅúÊ≠¢
            if (demoState.isDemo && (e.key === ' ' || e.key.toLowerCase() === 'w' || e.key.toLowerCase() === 's')) {
                stopDemo();
            }
            
            demoState.lastUserInput = Date.now();
            
            if (e.key === ' ') {
                if (gameState === 'waiting') {
                    startServing();
                } else if (gameState === 'serving') {
                    serveGame();
                } else if (gameState === 'gameWon') {
                    nextGame();
                } else if (gameState === 'matchWon') {
                    resetMatch();
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
            demoState.lastUserInput = Date.now();
        });
        
        function getPointDisplay(points, isDeuce, advantage, playerIndex) {
            if (isDeuce) {
                if (advantage === -1) return "40";
                if (advantage === playerIndex) return "Ad";
                return "40";
            }
            
            // „ÉÜ„Éã„Çπ„Éù„Ç§„É≥„ÉàË°®Á§∫: 0, 15, 30, 40
            const pointNames = ["0", "15", "30", "40"];
            return pointNames[Math.min(points, 3)];
        }
        
        function updateScoreDisplay() {
            document.getElementById('games1').textContent = tennisScore.games[0];
            document.getElementById('games2').textContent = tennisScore.games[1];
            
            // „Éù„Ç§„É≥„ÉàË°®Á§∫„ÅÆÂá¶ÁêÜ
            document.getElementById('points1').textContent = getPointDisplay(
                tennisScore.points[0], tennisScore.isDeuce, tennisScore.advantage, 0
            );
            document.getElementById('points2').textContent = getPointDisplay(
                tennisScore.points[1], tennisScore.isDeuce, tennisScore.advantage, 1
            );
            
            let status = "";
            
            // „Éá„É•„Éº„Çπ„Éª„Ç¢„Éâ„Éê„É≥„ÉÜ„Éº„Ç∏„ÅÆÁä∂ÊÖãË°®Á§∫
            if (tennisScore.isDeuce) {
                if (tennisScore.advantage === -1) {
                    status = "„Éá„É•„Éº„Çπ";
                } else if (tennisScore.advantage === 0) {
                    status = "„Éó„É¨„Ç§„É§„Éº „Ç¢„Éâ„Éê„É≥„ÉÜ„Éº„Ç∏";
                } else if (tennisScore.advantage === 1) {
                    status = "„Ç≥„É≥„Éî„É•„Éº„Çø„Éº „Ç¢„Éâ„Éê„É≥„ÉÜ„Éº„Ç∏";
                }
            }
            
            // „Ç≤„Éº„É†Áä∂ÊÖã„Å´„Çà„Çã‰∏äÊõ∏„Åç
            if (gameState === 'gameWon') {
                status = `${tennisScore.winner === 0 ? '„Éó„É¨„Ç§„É§„Éº' : '„Ç≥„É≥„Éî„É•„Éº„Çø„Éº'} „Ç≤„Éº„É†ÂãùÂà©! (SPACE „ÅßÊ¨°„ÅÆ„Ç≤„Éº„É†)`;
            } else if (gameState === 'matchWon') {
                status = `${tennisScore.winner === 0 ? '„Éó„É¨„Ç§„É§„Éº' : '„Ç≥„É≥„Éî„É•„Éº„Çø„Éº'} „Éû„ÉÉ„ÉÅÂãùÂà©! (SPACE „Åß„É™„Çπ„Çø„Éº„Éà)`;
            } else if (gameState === 'serving') {
                if (tennisScore.currentServer === 0) {
                    status = `„Éó„É¨„Ç§„É§„Éº„ÅÆ„Çµ„Éº„Éñ - W/S„Åß‰ΩçÁΩÆË™øÊï¥„ÄÅSPACE„Åß„Çµ„Éº„Éñ`;
                } else {
                    status = `„Ç≥„É≥„Éî„É•„Éº„Çø„Éº„ÅÆ„Çµ„Éº„Éñ`;
                }
            } else if (gameState === 'playing') {
                // „Éó„É¨„Ç§‰∏≠„ÅØ„Éá„É•„Éº„ÇπÁä∂ÊÖã„ÇíÂÑ™ÂÖà„Åó„Å¶Ë°®Á§∫
                if (!tennisScore.isDeuce) {
                    status = `„Çµ„Éº„Éê„Éº: ${tennisScore.currentServer === 0 ? '„Éó„É¨„Ç§„É§„Éº' : '„Ç≥„É≥„Éî„É•„Éº„Çø„Éº'}`;
                }
            }
            
            document.getElementById('status').textContent = status;
        }
        
        function addPoint(playerIndex) {
            if (tennisScore.isMatchWon) return;
            
            if (tennisScore.isDeuce) {
                if (tennisScore.advantage === -1) {
                    // „Éá„É•„Éº„Çπ„Åã„Çâ„Ç¢„Éâ„Éê„É≥„ÉÜ„Éº„Ç∏„Å∏
                    tennisScore.advantage = playerIndex;
                } else if (tennisScore.advantage === playerIndex) {
                    // „Ç¢„Éâ„Éê„É≥„ÉÜ„Éº„Ç∏„Åã„Çâ„Ç≤„Éº„É†ÂãùÂà©
                    winGame(playerIndex);
                    return;
                } else {
                    // Áõ∏Êâã„ÅÆ„Ç¢„Éâ„Éê„É≥„ÉÜ„Éº„Ç∏„Åã„ÇâÂÜç„Å≥„Éá„É•„Éº„Çπ„Å∏
                    tennisScore.advantage = -1;
                }
            } else {
                // ÈÄöÂ∏∏„ÅÆ„Éù„Ç§„É≥„ÉàÈÄ≤Ë°å 0 ‚Üí 1 ‚Üí 2 ‚Üí 3 ‚Üí „Ç≤„Éº„É†ÂãùÂà©
                tennisScore.points[playerIndex]++;
                
                // „Ç≤„Éº„É†ÂãùÂà©Âà§ÂÆö
                if (tennisScore.points[playerIndex] >= 4) {
                    if (tennisScore.points[playerIndex] - tennisScore.points[1 - playerIndex] >= 2) {
                        // 2„Éù„Ç§„É≥„ÉàÂ∑Æ„Åß„Ç≤„Éº„É†ÂãùÂà©
                        winGame(playerIndex);
                        return;
                    } else if (tennisScore.points[0] >= 3 && tennisScore.points[1] >= 3) {
                        // ‰∏°Êñπ„Åå3„Éù„Ç§„É≥„Éà‰ª•‰∏ä„Åß„Éá„É•„Éº„Çπ
                        tennisScore.isDeuce = true;
                    }
                }
            }
            
            updateScoreDisplay();
        }
        
        function winGame(playerIndex) {
            tennisScore.games[playerIndex]++;
            tennisScore.winner = playerIndex;
            
            // „Éû„ÉÉ„ÉÅÂãùÂà©Âà§ÂÆö - 3„Ç≤„Éº„É†ÂÖàÂèñ„ÅßÂãùÂà©
            if (tennisScore.games[playerIndex] >= 3) {
                tennisScore.isMatchWon = true;
                gameState = 'matchWon';
            } else {
                gameState = 'gameWon';
            }
            
            updateScoreDisplay();
        }
        
        function startServing() {
            gameState = 'serving';
            prepareServe();
            updateScoreDisplay();
        }
        
        function prepareServe() {
            // „Çµ„Éº„ÉñÊ∫ñÂÇôÔºö„Éú„Éº„É´„Çí„Çµ„Éº„Éê„Éº„ÅÆ‰ΩçÁΩÆ„Å´ÈÖçÁΩÆ
            if (tennisScore.currentServer === 0) {
                ball.x = player1.x + paddleWidth + 15;
                ball.y = player1.y + paddleHeight / 2;
            } else {
                ball.x = player2.x - 15;
                ball.y = player2.y + paddleHeight / 2;
                // „Ç≥„É≥„Éî„É•„Éº„Çø„Éº„ÅØËá™Âãï„Åß„Çµ„Éº„Éñ
                setTimeout(() => serveGame(), 1000);
            }
        }
        
        function serveGame() {
            gameState = 'playing';
            ball.hitCount = 0; // „É©„É™„Éº„Ç´„Ç¶„É≥„Çø„Éº„É™„Çª„ÉÉ„Éà
            ball.scored = false; // „Éù„Ç§„É≥„ÉàÊ∏à„Åø„Éï„É©„Ç∞„É™„Çª„ÉÉ„Éà
            
            // „Çµ„Éº„Éñ„ÅÆÊñπÂêë„Å®ÈÄüÂ∫¶„ÇíË®≠ÂÆö
            if (tennisScore.currentServer === 0) {
                ball.dx = 4;
                ball.dy = (Math.random() - 0.5) * 3;
            } else {
                ball.dx = -4;
                ball.dy = (Math.random() - 0.5) * 3;
            }
            
            updateScoreDisplay();
        }
        
        function nextGame() {
            // „Çµ„Éº„Éê„Éº‰∫§‰ª£
            tennisScore.currentServer = 1 - tennisScore.currentServer;
            
            // „Éù„Ç§„É≥„Éà„É™„Çª„ÉÉ„Éà
            tennisScore.points = [0, 0];
            tennisScore.isDeuce = false;
            tennisScore.advantage = -1;
            
            startServing();
        }
        
        function resetMatch() {
            tennisScore = {
                games: [0, 0],
                points: [0, 0],
                isDeuce: false,
                advantage: -1,
                currentServer: 0,
                isMatchWon: false,
                winner: -1
            };
            gameState = 'waiting';
            updateScoreDisplay();
        }
        
        function resetBall() {
            // Ê¨°„ÅÆ„Éù„Ç§„É≥„Éà„ÅÆ„Åü„ÇÅ„ÅÆ„Çµ„Éº„ÉñÊ∫ñÂÇô
            startServing();
        }
        
        function updateGame() {
            // „Éó„É¨„Ç§„É§„Éº1Ôºà‰∫∫ÈñìÔºâ„ÅÆÁßªÂãï„Å®„Çπ„Éî„Éº„ÉâË®àÁÆó
            player1.prevY = player1.y;
            if (keys['w'] && player1.y > 0) {
                player1.y -= paddleSpeed;
            }
            if (keys['s'] && player1.y < canvas.height - paddleHeight) {
                player1.y += paddleSpeed;
            }
            player1.velocity = player1.y - player1.prevY;
            
            // „Çµ„Éº„ÉñÊ∫ñÂÇô‰∏≠„ÅÆÂá¶ÁêÜ
            if (gameState === 'serving') {
                if (tennisScore.currentServer === 0) {
                    // „Éó„É¨„Ç§„É§„Éº„ÅÆ„Çµ„Éº„ÉñÊ∫ñÂÇô‰∏≠Ôºö„Éú„Éº„É´„ÇÇ‰∏ÄÁ∑í„Å´ÁßªÂãï
                    ball.y = player1.y + paddleHeight / 2;
                } else {
                    // „Ç≥„É≥„Éî„É•„Éº„Çø„Éº„ÅÆ„Çµ„Éº„ÉñÊ∫ñÂÇô‰∏≠
                    updateComputerPlayer();
                    ball.y = player2.y + paddleHeight / 2;
                }
                return;
            }
            
            if (gameState !== 'playing') return;
            
            // „Éó„É¨„Ç§„É§„Éº2Ôºà„Ç≥„É≥„Éî„É•„Éº„Çø„ÉºÔºâ„ÅÆAI
            updateComputerPlayer();
            
            // „Éú„Éº„É´„ÅÆÁßªÂãï
            ball.x += ball.dx;
            ball.y += ball.dy;
            
            // ‰∏ä‰∏ã„ÅÆÂ£Å„Å®„ÅÆË°ùÁ™Å
            if (ball.y <= ball.size || ball.y >= canvas.height - ball.size) {
                ball.dy = -ball.dy;
            }
            
            // „Éë„Éâ„É´„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
            // „Éó„É¨„Ç§„É§„Éº1„ÅÆ„Éë„Éâ„É´
            if (ball.x - ball.size <= player1.x + paddleWidth &&
                ball.y >= player1.y &&
                ball.y <= player1.y + paddleHeight &&
                ball.dx < 0) {
                ball.dx = -ball.dx;
                ball.dx *= 1.02;
                // „Éë„Éâ„É´„ÅÆÂãï„Åç„Çí„Éú„Éº„É´„Å´ÂèçÊò†
                ball.dy += player1.velocity * 0.3;
                ball.hitCount++; // „É©„É™„ÉºÂõûÊï∞Â¢óÂä†
            }
            
            // „Éó„É¨„Ç§„É§„Éº2„ÅÆ„Éë„Éâ„É´
            if (ball.x + ball.size >= player2.x &&
                ball.y >= player2.y &&
                ball.y <= player2.y + paddleHeight &&
                ball.dx > 0) {
                ball.dx = -ball.dx;
                ball.dx *= 1.02;
                // „Ç≥„É≥„Éî„É•„Éº„Çø„Éº„Éë„Éâ„É´„ÅÆÂãï„Åç„Çí„Éú„Éº„É´„Å´ÂèçÊò†
                ball.dy += player2.velocity * 0.3;
                ball.hitCount++; // „É©„É™„ÉºÂõûÊï∞Â¢óÂä†
            }
            
            // „Éù„Ç§„É≥„ÉàÂà§ÂÆö
            if (!ball.scored) { // „Åæ„Å†„Éù„Ç§„É≥„Éà„Åå‰ªò„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø
                if (ball.x < 0) {
                    ball.scored = true; // „Éù„Ç§„É≥„ÉàÊ∏à„Åø„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
                    addPoint(1); // „Ç≥„É≥„Éî„É•„Éº„Çø„Éº„ÅÆ„Éù„Ç§„É≥„Éà
                    ball.hitCount = 0; // „É©„É™„Éº„Ç´„Ç¶„É≥„Çø„Éº„É™„Çª„ÉÉ„Éà
                    if (gameState === 'playing') {
                        setTimeout(() => resetBall(), 1000);
                    }
                } else if (ball.x > canvas.width) {
                    ball.scored = true; // „Éù„Ç§„É≥„ÉàÊ∏à„Åø„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
                    addPoint(0); // „Éó„É¨„Ç§„É§„Éº„ÅÆ„Éù„Ç§„É≥„Éà
                    ball.hitCount = 0; // „É©„É™„Éº„Ç´„Ç¶„É≥„Çø„Éº„É™„Çª„ÉÉ„Éà
                    if (gameState === 'playing') {
                        setTimeout(() => resetBall(), 1000);
                    }
                }
            }
        }
        
        function updateComputerPlayer() {
            // ÂâçÂõû„ÅÆ‰ΩçÁΩÆ„ÇíË®òÈå≤
            player2.prevY = player2.y;
            
            // ÂèçÂøúÈÅÖÂª∂„ÇíÂá¶ÁêÜ
            if (player2.reactionDelay > 0) {
                player2.reactionDelay--;
                return; // ÈÅÖÂª∂‰∏≠„ÅØÁßªÂãï„Åó„Å™„ÅÑ
            }
            
            // „É©„É™„ÉºÂõûÊï∞„Å´Âü∫„Å•„ÅèÈõ£ÊòìÂ∫¶‰Ωé‰∏ã„ÅÆË®àÁÆó
            let rallyDifficulty = Math.max(0.3, player2.difficulty - (ball.hitCount * 0.08));
            let fatigueMultiplier = Math.max(0.4, 1 - (ball.hitCount * 0.06));
            
            // „Éú„Éº„É´„Åå„Ç≥„É≥„Éî„É•„Éº„Çø„ÉºÂÅ¥„Å´Âêë„Åã„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà
            if (ball.dx > 0) {
                // „É©„É™„Éº„ÅåÁ∂ö„Åè„Å®ÂèçÂøú„ÅåÈÅÖ„Åè„Å™„Çã
                if (ball.hitCount > 3 && Math.random() < 0.15 + (ball.hitCount * 0.05)) {
                    player2.reactionDelay = Math.floor(2 + ball.hitCount * 0.5);
                    return;
                }
                
                // „Éú„Éº„É´„ÅÆ‰∫àÊ∏¨‰ΩçÁΩÆ„ÇíË®àÁÆó
                let timeToReach = (player2.x - ball.x) / ball.dx;
                let predictedY = ball.y + (ball.dy * timeToReach);
                
                // Â£Å„Åß„ÅÆË∑≥„Å≠Ëøî„Çä„ÇíËÄÉÊÖÆ
                let bounceCount = 0;
                while (predictedY < 0 || predictedY > canvas.height) {
                    bounceCount++;
                    if (predictedY < 0) {
                        predictedY = -predictedY;
                    }
                    if (predictedY > canvas.height) {
                        predictedY = 2 * canvas.height - predictedY;
                    }
                    
                    // Ë§áÊï∞ÂõûË∑≥„Å≠Ëøî„Çä„Åå„ÅÇ„Çã„Å®‰∫àÊ∏¨Á≤æÂ∫¶„ÅåËêΩ„Å°„Çã
                    if (bounceCount > 1 && ball.hitCount > 2) {
                        let bounceError = (Math.random() - 0.5) * 40 * bounceCount;
                        predictedY += bounceError;
                    }
                }
                
                player2.targetY = predictedY - paddleHeight / 2;
                
                // „É©„É™„Éº„ÅåÁ∂ö„Åè„Å®‰∫àÊ∏¨Ë™§Â∑Æ„ÅåÂ§ß„Åç„Åè„Å™„Çã
                if (ball.hitCount > 2) {
                    let predictionErrorRange = 20 + (ball.hitCount * 8);
                    player2.predictionError = (Math.random() - 0.5) * predictionErrorRange * (1 - rallyDifficulty);
                    player2.targetY += player2.predictionError;
                }
            } else {
                // „Éú„Éº„É´„ÅåÈõ¢„Çå„Å¶„ÅÑ„ÅèÂ†¥Âêà„ÅØ‰∏≠Â§Æ„Å´Êàª„ÇãÔºàÁñ≤Âä¥„ÅßÈÅÖ„Åè„Å™„ÇãÔºâ
                player2.targetY = canvas.height / 2 - paddleHeight / 2;
            }
            
            // Èõ£ÊòìÂ∫¶„Å®„É©„É™„ÉºÁñ≤Âä¥„Å´Âü∫„Å•„ÅÑ„ÅüÁßªÂãïÈÄüÂ∫¶
            let baseSpeed = paddleSpeed * rallyDifficulty * fatigueMultiplier;
            
            // „É©„É™„Éº„ÅåÁ∂ö„Åè„Å®„Åï„Çâ„Å´ÈÅÖ„Åè„Å™„Çã
            if (ball.hitCount > 5) {
                baseSpeed *= Math.max(0.3, 1 - ((ball.hitCount - 5) * 0.1));
            }
            
            // Âü∫Êú¨ÁöÑ„Å™„É©„É≥„ÉÄ„É†„Ç®„É©„Éº
            let basicError = (Math.random() - 0.5) * 25 * (1 - rallyDifficulty);
            let adjustedTargetY = player2.targetY + basicError;
            
            // Â¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ
            adjustedTargetY = Math.max(0, Math.min(canvas.height - paddleHeight, adjustedTargetY));
            
            // „Çπ„É†„Éº„Ç∫„Å™ÁßªÂãï
            let diff = adjustedTargetY - player2.y;
            if (Math.abs(diff) > baseSpeed) {
                player2.y += diff > 0 ? baseSpeed : -baseSpeed;
            } else {
                player2.y = adjustedTargetY;
            }
            
            // Â¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ
            player2.y = Math.max(0, Math.min(canvas.height - paddleHeight, player2.y));
            
            // ÈÄüÂ∫¶„ÇíË®àÁÆó
            player2.velocity = player2.y - player2.prevY;
        }
        
        function drawGame() {
            // ÁîªÈù¢„ÇØ„É™„Ç¢ - „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ËÉåÊôØ
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#0f3460');
            gradient.addColorStop(1, '#16537e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ‰∏≠Â§ÆÁ∑ö„ÇíÊèèÁîª - Êòé„Çã„ÅÑÈùí
            ctx.strokeStyle = '#4ecdc4';
            ctx.lineWidth = 3;
            ctx.setLineDash([15, 10]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // „Éë„Éâ„É´„ÇíÊèèÁîª - „Ç´„É©„Éï„É´
            // „Éó„É¨„Ç§„É§„Éº„Éë„Éâ„É´ÔºàÂ∑¶Ôºâ- Ëµ§Á≥ª
            if (demoState.isDemo) {
                ctx.shadowColor = '#00ffff';
                ctx.shadowBlur = 15;
            }
            const playerGradient = ctx.createLinearGradient(player1.x, player1.y, player1.x + paddleWidth, player1.y + paddleHeight);
            if (demoState.isDemo) {
                playerGradient.addColorStop(0, '#00ffff');
                playerGradient.addColorStop(1, '#0099cc');
            } else {
                playerGradient.addColorStop(0, '#ff6b6b');
                playerGradient.addColorStop(1, '#ee5a52');
            }
            ctx.fillStyle = playerGradient;
            ctx.fillRect(player1.x, player1.y, paddleWidth, paddleHeight);
            if (demoState.isDemo) {
                ctx.shadowBlur = 0;
            }
            
            // „Ç≥„É≥„Éî„É•„Éº„Çø„Éº„Éë„Éâ„É´ÔºàÂè≥Ôºâ- Á∑ëÁ≥ª
            const computerGradient = ctx.createLinearGradient(player2.x, player2.y, player2.x + paddleWidth, player2.y + paddleHeight);
            computerGradient.addColorStop(0, '#96ceb4');
            computerGradient.addColorStop(1, '#74b9a0');
            ctx.fillStyle = computerGradient;
            ctx.fillRect(player2.x, player2.y, paddleWidth, paddleHeight);
            
            // „Éú„Éº„É´„ÇíÊèèÁîª - Êòé„Çã„ÅÑÈªÑËâ≤„ÅßÂÖâ„ÇãÂäπÊûú
            if (gameState === 'playing' || gameState === 'serving') {
                // „Éú„Éº„É´„ÅÆÂΩ±ÂäπÊûú
                ctx.beginPath();
                ctx.arc(ball.x + 2, ball.y + 2, ball.size, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fill();
                
                // „É°„Ç§„É≥„Éú„Éº„É´
                const ballGradient = ctx.createRadialGradient(ball.x - 2, ball.y - 2, 0, ball.x, ball.y, ball.size);
                ballGradient.addColorStop(0, '#ffeb3b');
                ballGradient.addColorStop(1, '#ffc107');
                ctx.fillStyle = ballGradient;
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.size, 0, Math.PI * 2);
                ctx.fill();
                
                // „Éú„Éº„É´„ÅÆ„Éè„Ç§„É©„Ç§„Éà
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(ball.x - 3, ball.y - 3, 2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // „Ç≤„Éº„É†ÈñãÂßãÂâç„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            if (gameState === 'waiting') {
                ctx.font = '20px Courier New';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#ffeb3b';
                ctx.strokeStyle = '#ff6b6b';
                ctx.lineWidth = 2;
                ctx.strokeText('SPACE „Ç≠„Éº„Åß„Ç≤„Éº„É†ÈñãÂßã', canvas.width / 2, canvas.height / 2 + 50);
                ctx.fillText('SPACE „Ç≠„Éº„Åß„Ç≤„Éº„É†ÈñãÂßã', canvas.width / 2, canvas.height / 2 + 50);
            }
            
            // „Çµ„Éº„ÉñÊ∫ñÂÇô‰∏≠„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            if (gameState === 'serving' && tennisScore.currentServer === 0) {
                ctx.font = '16px Courier New';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#4ecdc4';
                ctx.strokeStyle = '#45b7d1';
                ctx.lineWidth = 1;
                ctx.strokeText('W/S „Åß‰ΩçÁΩÆË™øÊï¥, SPACE „Åß„Çµ„Éº„Éñ', canvas.width / 2, 30);
                ctx.fillText('W/S „Åß‰ΩçÁΩÆË™øÊï¥, SPACE „Åß„Çµ„Éº„Éñ', canvas.width / 2, 30);
            }
        }
        
        // „Éá„É¢„É¢„Éº„ÉâÈñ¢ÈÄ£Èñ¢Êï∞
        function checkDemoMode() {
            if (demoState.isDemo || gameState !== 'waiting') return;
            
            // 5ÁßíÈñìÊìç‰Ωú„Åå„Å™„Åë„Çå„Å∞„Éá„É¢„É¢„Éº„ÉâÈñãÂßã
            if (Date.now() - demoState.lastUserInput > 5000) {
                startDemo();
            }
        }
        
        function startDemo() {
            demoState.isDemo = true;
            demoState.demoStartTime = Date.now();
            demoState.demoActionTimer = 0;
            
            // „Éá„É¢Ë°®Á§∫„ÇíË°®Á§∫
            document.getElementById('demoText').style.display = 'block';
            
            // „Éá„É¢„Ç≤„Éº„É†„ÇíËá™ÂãïÈñãÂßã
            setTimeout(() => {
                if (demoState.isDemo) {
                    startServing();
                    setTimeout(() => {
                        if (demoState.isDemo && gameState === 'serving') {
                            serveGame();
                        }
                    }, 1500);
                }
            }, 500);
        }
        
        function stopDemo() {
            demoState.isDemo = false;
            demoState.lastUserInput = Date.now();
            
            // „Éá„É¢Ë°®Á§∫„ÇíÈùûË°®Á§∫
            document.getElementById('demoText').style.display = 'none';
        }
        
        function updateDemoAI() {
            demoState.demoActionTimer++;
            
            // Áä∂ÊÖã„ÅåÂ§â„Çè„Å£„Åü„Çâ„Çø„Ç§„Éû„Éº„Çí„É™„Çª„ÉÉ„Éà
            if (gameState !== demoState.lastState) {
                demoState.waitingTimer = 0;
                demoState.lastState = gameState;
            }
            demoState.waitingTimer++;
            
            if (gameState === 'playing') {
                // „Éó„É¨„Ç§„É§„Éº1ÔºàÂ∑¶„Éë„Éâ„É´Ôºâ„ÅÆAIÂà∂Âæ°
                const ballCenterY = ball.y;
                const paddleCenterY = player1.y + paddleHeight / 2;
                const targetY = ballCenterY - paddleHeight / 2;
                
                // „Çπ„É†„Éº„Ç∫„Å™ÁßªÂãï
                const diff = targetY - player1.y;
                if (Math.abs(diff) > 2) {
                    if (diff > 0) {
                        keys['s'] = true;
                        keys['w'] = false;
                    } else {
                        keys['w'] = true;
                        keys['s'] = false;
                    }
                } else {
                    keys['w'] = false;
                    keys['s'] = false;
                }
            } else if (gameState === 'serving' && tennisScore.currentServer === 0) {
                // „Éá„É¢„É¢„Éº„Éâ‰∏≠„ÅÆ„Éó„É¨„Ç§„É§„Éº„Çµ„Éº„Éñ„ÇíËá™ÂãïÂåñ
                if (demoState.waitingTimer > 60) { // Á¥Ñ1ÁßíÂæå„Å´„Çµ„Éº„Éñ
                    serveGame();
                    demoState.waitingTimer = 0;
                }
            } else if (gameState === 'waiting') {
                // „Éá„É¢„É¢„Éº„Éâ‰∏≠„ÅØËá™Âãï„Åß„Ç≤„Éº„É†ÈñãÂßã
                if (demoState.waitingTimer > 120) { // Á¥Ñ2ÁßíÂæå„Å´„Ç≤„Éº„É†ÈñãÂßã
                    startServing();
                    demoState.waitingTimer = 0;
                }
            } else if (gameState === 'matchWon') {
                // „Éû„ÉÉ„ÉÅÂãùÂà©Âæå„ÄÅ3ÁßíÂæÖ„Å£„Å¶ÂæÖÊ©üÁîªÈù¢„Å∏Êàª„Åô
                if (demoState.waitingTimer > 180) { // Á¥Ñ3ÁßíÂæå
                    // „Éá„É¢„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü„Åó„Å¶ÂæÖÊ©üÁîªÈù¢„Å∏
                    stopDemo();
                    resetMatch();
                    // ÂæÖÊ©üÁîªÈù¢„Å´„Å™„Å£„Åü„ÅÆ„Åß„ÄÅlastUserInput„ÇíÊõ¥Êñ∞„Åó„Å¶5ÁßíÂæå„Å´„Åæ„Åü„Éá„É¢„ÅåÂßã„Åæ„Çã„Çà„ÅÜ„Å´„Åô„Çã
                    demoState.lastUserInput = Date.now();
                    demoState.waitingTimer = 0;
                }
            } else {
                keys['w'] = false;
                keys['s'] = false;
            }
        }
        
        // „Ç≤„Éº„É†„É´„Éº„Éó
        function gameLoop() {
            // „Éá„É¢„É¢„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
            if (!demoState.isDemo && gameState === 'waiting') {
                checkDemoMode();
            }
            
            // „Éá„É¢„É¢„Éº„Éâ‰∏≠„ÅÆAIÂà∂Âæ°
            if (demoState.isDemo) {
                updateDemoAI();
            }
            
            updateGame();
            drawGame();
            requestAnimationFrame(gameLoop);
        }
        
        // ÂàùÊúüÂåñ
        updateScoreDisplay();
        gameLoop();
    </script>
</body>
</html>